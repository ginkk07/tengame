<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœˆåéŠæˆ²</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #27ae60;
            --bg-color: #f0f4f8;
            --tile-active: #ffbe76;
            --text-color: #2c3e50;
        }

        body {
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-color);
        }

        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            background: white;
            padding: 30px;
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            width: 500px;
            text-align: center;
            box-sizing: border-box;
            margin: 20px;
        }

        .screen.active { display: flex; }

        h1 { font-size: 36px; margin: 0 0 20px 0; color: var(--primary-color); }

        .name-input-group { margin-bottom: 20px; }
        input {
            padding: 10px; /* ç¸®å°å…§è· */
            font-size: 16px; /* ç¸®å°å­—é«” */
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            width: 200px; /* ç¸®å°å¯¬åº¦ä»¥é…åˆæŒ‰éˆ• */
            text-align: center;
            outline: none;
        }

        /* --- CSS æŒ‰éˆ•ä¿®æ”¹é‡é» --- */
        .btn {
            padding: 10px 0; /* ç¸®å°å‚ç›´å…§è· (åŸæœ¬ 14px) */
            font-size: 18px; /* ç¸®å°å­—é«” (åŸæœ¬ 18px) */
            margin: 6px 0;   /* ç¸®å°é–“è· (åŸæœ¬ 8px) */
            border: none;
            border-radius: 50px;
            cursor: pointer;
            width: 200px;    /* ç¸®å°å¯¬åº¦ (åŸæœ¬ 240px) */
            font-weight: bold;
            transition: transform 0.2s;
        }
        /* ----------------------- */

        .btn-start { background: var(--secondary-color); color: white; }
        .btn-rank { background: var(--primary-color); color: white; }
        .btn-upload { background: #f39c12; color: white; }
        .btn-back { background: #95a5a6; color: white; }

        .game-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 15px;
            font-size: 22px;
            font-weight: bold;
        }
        #game-canvas-container { background: #eee; padding: 5px; border-radius: 12px; }
        canvas { background: #fff; border-radius: 8px; cursor: default; display: block; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 8px; border-bottom: 1px solid #eee; font-size: 15px; } /* è¡¨æ ¼ä¹Ÿç¨å¾®ç¸®å°ä¸€é» */
        
        .result-score { font-size: 64px; font-weight: bold; color: var(--primary-color); margin: 10px 0; }

        .rank-1 { background-color: rgba(255, 215, 0, 0.1); color: #b8860b; }
        .rank-2 { background-color: rgba(192, 192, 192, 0.1); color: #708090; }
        .rank-3 { background-color: rgba(205, 127, 50, 0.1); color: #8b4513; }
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <h1>åœˆåéŠæˆ²</h1>
        <div class="name-input-group">
            <input type="text" id="home-player-name" value="ç„¡åè‹±é›„" maxlength="10">
        </div>
        <button class="btn btn-start" onclick="startGame()">é–‹å§‹éŠæˆ²</button>
        <button class="btn btn-rank" onclick="showLeaderboard()">æ’è¡Œæ¦œ</button>
    </div>

    <div id="screen-rank" class="screen">
        <h1>å…¨çƒæ’è¡Œæ¦œ</h1>
        <table id="rank-table">
            <thead><tr><th>æ’å</th><th>ç©å®¶</th><th>å¾—åˆ†</th></tr></thead>
            <tbody id="rank-body"></tbody>
        </table>
        <button class="btn btn-back" onclick="showHome()">å›ä¸»é¸å–®</button>
    </div>

    <div id="screen-game" class="screen">
        <div class="game-header">
            <div>Score: <span id="score">0</span></div>
            <div style="color: #e74c3c;">Time: <span id="timer">60</span>s</div>
        </div>
        <div id="game-canvas-container">
            <canvas id="gameCanvas" width="400" height="640"></canvas>
        </div>
        <button class="btn btn-back" onclick="triggerCanvasConfirm()" style="width: 160px; font-size: 14px;">çµæŸéŠæˆ²</button>
    </div>

    <div id="screen-result" class="screen">
        <h1>éŠæˆ²çµæŸ</h1>
        <div class="result-score" id="final-result-score">0</div>
        <p id="result-player-display" style="margin-bottom: 20px;"></p>
        <button class="btn btn-upload" id="upload-btn" onclick="submitScore()">ä¸Šå‚³æˆç¸¾</button>
        <button class="btn btn-back" onclick="showHome()">å›ä¸»é¸å–®</button>
    </div>

<script>
    // è«‹ç¢ºä¿é€™æ˜¯ä½ æœ€æ–°éƒ¨ç½²çš„ /exec ç¶²å€
    const GAS_URL = "https://script.google.com/macros/s/AKfycbywi6spIec2aA3gD9gQbDu1w-4XJZ0wy3ZDdTWGlMX33FYZtuk7kmQjN7OKxJlJHkGr/exec";

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const ROWS = 16, COLS = 10, GRID_SIZE = 40, MARGIN = 3;

    let grid = [], score = 0, timeLeft = 60, gameActive = false, isConfirmingQuit = false;
    let isDragging = false, startPos = { x: 0, y: 0 }, currentPos = { x: 0, y: 0 };
    let currentPlayerName = "ç„¡åè‹±é›„";
    
    let particles = [];
    const pColors = ['#f1c40f', '#e67e22', '#e74c3c', '#3498db', '#2ecc71'];

    // --- Canvas æŒ‰éˆ•ä¿®æ”¹é‡é» ---
    // ç¸®å°å¯¬åº¦(w)å’Œé«˜åº¦(h)ï¼Œä¸¦é‡æ–°è¨ˆç®— x åº§æ¨™ä»¥ä¿æŒç½®ä¸­
    const btnRestart = { x: 75, y: 345, w: 120, h: 40 }; // åŸæœ¬ w:140, h:48
    const btnQuit = { x: 205, y: 345, w: 120, h: 40 };    // åŸæœ¬ w:140, h:48
    // -------------------------

    let lastTime = 0, timerAccumulator = 0;

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function showHome() { showScreen('screen-home'); gameActive = false; }

    function startGame() {
        currentPlayerName = document.getElementById('home-player-name').value.trim() || "ç„¡åè‹±é›„";
        showScreen('screen-game');
        score = 0; timeLeft = 60; gameActive = true; isConfirmingQuit = false; particles = [];
        document.getElementById('score').innerText = score;
        document.getElementById('timer').innerText = timeLeft;
        initGrid();
        lastTime = performance.now();
        requestAnimationFrame(gameLoop);
    }

    function gameLoop(timestamp) {
        if (!gameActive) return;
        const dt = timestamp - lastTime; lastTime = timestamp;
        timerAccumulator += dt;
        if (timerAccumulator >= 1000) {
            timeLeft--; 
            document.getElementById('timer').innerText = timeLeft;
            timerAccumulator -= 1000;
            if (timeLeft <= 0) { endGame(); return; }
        }
        render();
        requestAnimationFrame(gameLoop);
    }

    function initGrid() {
        const total = ROWS * COLS, nums = [];
        for (let i = 0; i < total / 2; i++) { 
            let n = Math.floor(Math.random() * 9) + 1; 
            nums.push(n, 10 - n); 
        }
        for (let i = nums.length - 1; i > 0; i--) { 
            const j = Math.floor(Math.random() * (i + 1)); 
            [nums[i], nums[j]] = [nums[j], nums[i]]; 
        }
        grid = Array.from({ length: ROWS }, (_, r) => 
            Array.from({ length: COLS }, (_, c) => ({ 
                val: nums[r * COLS + c], removed: false, active: false 
            }))
        );
    }

    function spawnParticles(x, y) {
        for (let i = 0; i < 20; i++) {
            const ang = Math.random() * Math.PI * 2;
            const spd = Math.random() * 4 + 2;
            particles.push({
                x, y, vx: Math.cos(ang) * spd, vy: Math.sin(ang) * spd,
                life: Math.random() * 30 + 20, size: Math.random() * 5 + 2,
                color: pColors[Math.floor(Math.random() * pColors.length)], type: 'dot'
            });
        }
    }

    function triggerCanvasConfirm() { if (gameActive) { isConfirmingQuit = !isConfirmingQuit; } }

    function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let r = 0; r < ROWS; r++) {
            for (let c = 0; c < COLS; c++) {
                if (grid[r][c].removed) continue;
                let x = c * GRID_SIZE + MARGIN, y = r * GRID_SIZE + MARGIN, size = GRID_SIZE - MARGIN * 2;
                ctx.beginPath(); ctx.roundRect(x, y, size, size, 6);
                ctx.fillStyle = grid[r][c].active ? '#ffbe76' : '#ffffff'; ctx.fill();
                ctx.strokeStyle = grid[r][c].active ? '#e67e22' : '#f1f3f5'; ctx.lineWidth = 1.5; ctx.stroke();
                ctx.fillStyle = grid[r][c].active ? '#fff' : '#2c3e50'; ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(grid[r][c].val, x + size/2, y + size/2);
            }
        }
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life--; 
            ctx.globalAlpha = p.life / 60;
            ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
            p.vy += 0.1; 
            if (p.life <= 0) particles.splice(i, 1);
        }
        ctx.globalAlpha = 1;

        if (isDragging && !isConfirmingQuit) {
            ctx.strokeStyle = '#3498db'; ctx.setLineDash([5, 3]);
            ctx.strokeRect(startPos.x, startPos.y, currentPos.x - startPos.x, currentPos.y - startPos.y);
            ctx.setLineDash([]); ctx.fillStyle = 'rgba(52, 152, 219, 0.1)';
            ctx.fillRect(startPos.x, startPos.y, currentPos.x - startPos.x, currentPos.y - startPos.y);
        }
        if (isConfirmingQuit) {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.roundRect(40, 250, 320, 170, 20); ctx.fill();
            ctx.fillStyle = '#2c3e50'; ctx.font = 'bold 22px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'top';
            ctx.fillText('ç¢ºå®šè¦çµæŸéŠæˆ²å—ï¼Ÿ', canvas.width/2, 285);
            drawCanvasButton(btnRestart, '#27ae60', 'é‡æ–°é–‹å§‹');
            drawCanvasButton(btnQuit, '#95a5a6', 'çµæŸéŠæˆ²');
        }
    }

    function drawCanvasButton(btn, color, text) {
        ctx.fillStyle = color; ctx.beginPath(); ctx.roundRect(btn.x, btn.y, btn.w, btn.h, 24); ctx.fill();
        ctx.fillStyle = '#fff'; 
        ctx.font = 'bold 16px Arial'; // ç¸®å° Canvas æŒ‰éˆ•å­—é«” (åŸæœ¬ 18px)
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(text, btn.x + btn.w/2, btn.y + btn.h/2);
    }

    canvas.addEventListener('mousedown', (e) => {
        if (!gameActive) return;
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left, my = e.clientY - rect.top;
        if (isConfirmingQuit) {
            if (isInside(mx, my, btnRestart)) startGame();
            else if (isInside(mx, my, btnQuit)) { gameActive = false; showHome(); }
            else { isConfirmingQuit = false; }
            return;
        }
        isDragging = true; startPos = { x: mx, y: my }; currentPos = { ...startPos };
        updateActiveStates();
    });

    window.addEventListener('mousemove', (e) => {
        if (!isDragging || !gameActive || isConfirmingQuit) return;
        const rect = canvas.getBoundingClientRect();
        currentPos = { x: e.clientX - rect.left, y: e.clientY - rect.top };
        updateActiveStates();
    });

    window.addEventListener('mouseup', () => {
        if (!isDragging) return;
        isDragging = false;
        let selected = grid.flat().filter(cell => !cell.removed && cell.active);
        if (selected.reduce((s, c) => s + c.val, 0) === 10 && selected.length > 0) {
            timeLeft += 5;
            document.getElementById('timer').innerText = timeLeft;

            let minC=COLS, maxC=0, minR=ROWS, maxR=0;
            grid.forEach((row, r) => row.forEach((cell, c) => {
                if(cell.active && !cell.removed) {
                    minC=Math.min(minC, c); maxC=Math.max(maxC, c);
                    minR=Math.min(minR, r); maxR=Math.max(maxR, r);
                }
            }));
            const cx = (minC + maxC + 1) * GRID_SIZE / 2;
            const cy = (minR + maxR + 1) * GRID_SIZE / 2;
            
            const gained = selected.length * 100;
            score += gained;
            document.getElementById('score').innerText = score;
            spawnParticles(cx, cy);
            selected.forEach(c => c.removed = true);
        }
        grid.flat().forEach(c => c.active = false);
        if (grid.flat().every(c => c.removed)) endGame();
    });

    function updateActiveStates() {
        let x1 = Math.min(startPos.x, currentPos.x), x2 = Math.max(startPos.x, currentPos.x);
        let y1 = Math.min(startPos.y, currentPos.y), y2 = Math.max(startPos.y, currentPos.y);
        for (let r = 0; r < ROWS; r++) for (let c = 0; c < COLS; c++) {
            let tx1 = c * GRID_SIZE, tx2 = (c+1) * GRID_SIZE, ty1 = r * GRID_SIZE, ty2 = (r+1) * GRID_SIZE;
            grid[r][c].active = !(tx2 < x1 || tx1 > x2 || ty2 < y1 || ty1 > y2);
        }
    }

    function isInside(mx, my, btn) { return mx >= btn.x && mx <= btn.x + btn.w && my >= btn.y && my <= btn.y + btn.h; }

    function endGame() {
        gameActive = false;
        document.getElementById('final-result-score').innerText = score;
        document.getElementById('result-player-display').innerText = `Player: ${currentPlayerName}`;
        const b = document.getElementById('upload-btn'); b.disabled = false; b.innerText = "ä¸Šå‚³æˆç¸¾";
        showScreen('screen-result');
    }

    // --- fetch é€šè¨Š (GitHub Pages ç”¨) ---
    async function submitScore() {
        const b = document.getElementById('upload-btn');
        b.disabled = true; b.innerText = "ä¸Šå‚³ä¸­...";
        try {
            const resp = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ name: currentPlayerName, score: score })
            });
            const ranks = await resp.json();
            localStorage.setItem('math_game_rank', JSON.stringify(ranks));
            alert("ğŸ‰ æˆç¸¾ä¸Šå‚³æˆåŠŸï¼");
            showLeaderboard();
        } catch (e) {
            console.error(e);
            alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            b.disabled = false; b.innerText = "é‡è©¦ä¸Šå‚³";
        }
    }

    async function showLeaderboard() {
        showScreen('screen-rank');
        const tbody = document.getElementById('rank-body'); 
        tbody.innerHTML = "<tr><td colspan='3'>åŒæ­¥é›²ç«¯æ•¸æ“šä¸­...</td></tr>";
        try {
            const resp = await fetch(GAS_URL); // GET è«‹æ±‚å–å¾—æ’è¡Œ
            const ranks = await resp.json();
            renderTable(ranks);
        } catch (e) {
            console.error(e);
            const localRanks = JSON.parse(localStorage.getItem('math_game_rank')) || [];
            renderTable(localRanks);
        }
    }

    function renderTable(ranks) {
        const tbody = document.getElementById('rank-body');
        if (!ranks || ranks.length === 0) {
            tbody.innerHTML = "<tr><td colspan='3' style='padding:20px; color:#95a5a6;'>æš«ç„¡ç´€éŒ„</td></tr>";
            return;
        }
        tbody.innerHTML = ranks.slice(0, 10).map((r, i) => {
            let rankClass = "", medal = "";
            if (i === 0) { rankClass = "rank-1"; medal = "ğŸ¥‡ "; }
            else if (i === 1) { rankClass = "rank-2"; medal = "ğŸ¥ˆ "; }
            else if (i === 2) { rankClass = "rank-3"; medal = "ğŸ¥‰ "; }
            return `<tr class="${rankClass}"><td>${medal}${i + 1}</td><td>${r.name || '-'}</td><td style="font-weight:bold">${r.score || 0}</td></tr>`;
        }).join('');
    }
</script>
</body>
</html>
